# syntax=docker/dockerfile:1

# Stage 1: Frontend Development with optimized caching
FROM --platform=$BUILDPLATFORM node:25-trixie-slim AS frontend-dev

RUN npm install -g --force corepack && corepack enable pnpm

ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
ENV CI=true

WORKDIR /app

# pnpm fetch only requires lockfile
COPY pnpm-lock.yaml pnpm-workspace.yaml ./

# Fetch dependencies with cache mount
RUN --mount=type=cache,id=pnpm,target=/pnpm/store \
    pnpm fetch

# Copy package files and frontend source
COPY package.json ./
COPY frontend ./frontend

# Install from the store (offline)
RUN --mount=type=cache,id=pnpm,target=/pnpm/store \
    pnpm install -r --offline

ENV NODE_ENV=development \
    PORT=3000

EXPOSE 3000

CMD ["pnpm", "-C", "frontend", "dev", "--host", "0.0.0.0"]

# Stage 2: Backend Development with optimized caching
FROM --platform=$BUILDPLATFORM golang:1.25-trixie AS backend-dev

# Install development tools in a single layer
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    curl \
    git \
    tzdata && \
    rm -rf /var/lib/apt/lists/* && \
    go install github.com/air-verse/air@latest

ENV GIN_MODE=debug \
    PORT=3552 \
    ENVIRONMENT=development \
    GOCACHE=/root/.cache/go-build \
    GOMODCACHE=/go/pkg/mod

WORKDIR /app

# Copy Go workspace file and all modules first
COPY go.work ./go.work
COPY types/ ./types/
COPY cli/ ./cli/

# Copy backend Go module files for dependency caching
COPY backend/go.mod backend/go.sum ./backend/

# Download dependencies with cache mounts
RUN --mount=type=cache,target=/go/pkg/mod \
    --mount=type=cache,target=/root/.cache/go-build \
    cd backend && go mod download && go mod verify

# Create directories with proper permissions
RUN mkdir -p /app/data /app/.bin /builds && \
    chmod 755 /app/data /app/.bin

WORKDIR /app/backend

EXPOSE 3552

CMD ["air", "-c", ".air.toml"]
